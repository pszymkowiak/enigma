---
- name: Deploy Enigma cluster
  hosts: enigma
  become: true
  vars:
    enigma_version: "latest"
    data_dir: /opt/enigma
    raft_port: 9000
    s3_port: 8333
    rustfs_port: 9001

  tasks:
    # ── Dependencies ──────────────────────────────────
    - name: Install Docker
      apt:
        name: [docker.io, docker-compose-v2, awscli]
        state: present
        update_cache: true

    - name: Ensure Docker is running
      systemd:
        name: docker
        state: started
        enabled: true

    - name: Add user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: true

    # ── Directories ───────────────────────────────────
    - name: Create data directories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ data_dir }}"
        - "{{ data_dir }}/raft"
        - "{{ data_dir }}/rustfs"

    # ── RustFS (local S3 backend) ─────────────────────
    - name: Start RustFS container
      community.docker.docker_container:
        name: rustfs
        image: rustfs/rustfs:latest
        command: ["/data"]
        state: started
        restart_policy: unless-stopped
        ports:
          - "{{ rustfs_port }}:9000"
        volumes:
          - "{{ data_dir }}/rustfs:/data"
        env:
          RUSTFS_ACCESS_KEY: "{{ rustfs_access_key }}"
          RUSTFS_SECRET_KEY: "{{ rustfs_secret_key }}"

    - name: Wait for RustFS
      uri:
        url: "http://127.0.0.1:{{ rustfs_port }}/minio/health/live"
        status_code: 200
      register: result
      until: result.status == 200
      retries: 30
      delay: 2

    - name: Create enigma-chunks bucket
      command: >
        aws --endpoint-url http://127.0.0.1:{{ rustfs_port }}
        s3 mb s3://enigma-chunks
      environment:
        AWS_ACCESS_KEY_ID: "{{ rustfs_access_key }}"
        AWS_SECRET_ACCESS_KEY: "{{ rustfs_secret_key }}"
      register: bucket_result
      failed_when: bucket_result.rc != 0 and 'BucketAlreadyOwnedByYou' not in bucket_result.stderr
      changed_when: bucket_result.rc == 0

    # ── Enigma Binary ─────────────────────────────────
    - name: Copy Enigma proxy binary
      copy:
        src: ../../target/release/enigma-proxy
        dest: /usr/local/bin/enigma-proxy
        mode: "0755"

    # ── Configuration ─────────────────────────────────
    - name: Generate Enigma config
      template:
        src: enigma-config.toml.j2
        dest: "{{ data_dir }}/config.toml"
        mode: "0600"
      notify: Restart Enigma

    # ── Systemd Service ───────────────────────────────
    - name: Install systemd unit
      template:
        src: enigma-proxy.service.j2
        dest: /etc/systemd/system/enigma-proxy.service
      notify: Restart Enigma

    - name: Enable and start Enigma
      systemd:
        name: enigma-proxy
        state: started
        enabled: true
        daemon_reload: true

  handlers:
    - name: Restart Enigma
      systemd:
        name: enigma-proxy
        state: restarted
        daemon_reload: true
